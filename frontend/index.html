<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knee MRI Analysis Pipeline</title>
    <link rel="stylesheet" href="/css/styles.css">
    <!-- FilePond CSS (pinned version for reproducibility) -->
    <link href="https://unpkg.com/filepond@4.31.4/dist/filepond.css" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <header>
            <h1>ü¶¥ Knee MRI Analysis Pipeline</h1>
            <p class="subtitle">Automated segmentation and analysis of knee MRI data</p>
        </header>

        <!-- Upload Section -->
        <section id="upload-section" class="section">
            <div class="upload-area">
                <input type="file" id="file-input">
            </div>
            
            <div class="config-panel">
                <h3>Configuration</h3>
                
                <div class="form-group">
                    <label for="email-input">Email (optional):</label>
                    <input type="email" id="email-input" placeholder="your@email.com">
                    <p class="help-text">
                        For usage tracking and to receive your download link via email.
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="seg-model">Segmentation Model:</label>
                    <select id="seg-model">
                        <option value="nnunet_fullres" selected>nnU-Net FullRes (recommended)</option>
                        <!-- Models are dynamically loaded from /models API -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="perform-nsm" checked>
                        Perform Shape Modeling (NSM)
                    </label>
                </div>
                
                <div class="form-group" id="nsm-options">
                    <label>NSM Type:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="nsm-type" value="bone_and_cart" checked>
                            Bone + Cartilage
                        </label>
                        <label>
                            <input type="radio" name="nsm-type" value="bone_only">
                            Bone Only
                        </label>
                        <label>
                            <input type="radio" name="nsm-type" value="both">
                            Both
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="retain-results" checked>
                        Allow anonymized results to be retained for research
                    </label>
                    <p class="help-text">
                        Only derived data (segmentations, meshes, metrics) will be retained. 
                        No original MRI images are stored.
                    </p>
                </div>
                
                <details class="advanced-options">
                    <summary>Advanced Options</summary>
                    <div class="advanced-options-content">
                        <div class="form-group">
                            <label for="cartilage-smoothing">Cartilage Smoothing (0.0-2.0 mm):</label>
                            <input type="number" id="cartilage-smoothing" 
                                   min="0" max="2" step="0.1" value="0.4">
                            <p class="help-text">
                                Variance for Gaussian smoothing of cartilage surfaces.
                            </p>
                        </div>
                        <div class="form-group">
                            <label for="batch-size">Batch Size (1-256):</label>
                            <input type="number" id="batch-size" 
                                   min="1" max="256" value="128">
                            <p class="help-text">
                                Batch size for model inference. Lower values use less GPU memory.
                            </p>
                        </div>
                    </div>
                </details>
            </div>
            
            <button id="submit-btn" class="btn primary" disabled>
                Process Data
            </button>
        </section>

        <!-- Processing Section -->
        <section id="processing-section" class="section hidden">
            <div class="processing-info">
                <h2>Processing: <span id="processing-filename"></span></h2>
                
                <div class="alert warning">
                    ‚ö†Ô∏è Please keep this page open until processing completes.
                </div>
                
                <!-- Connection warning (shown after multiple poll failures) -->
                <div id="connection-warning" class="alert error hidden">
                    ‚ö†Ô∏è Connection issues detected. Retrying...
                </div>
                
                <div class="queue-info">
                    <p>Queue Position: <strong id="queue-position">#1</strong></p>
                    <p>Estimated Wait: <strong id="estimated-wait">~4 minutes</strong></p>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <p class="progress-text">
                        <span id="progress-percent">0%</span> - 
                        <span id="step-name">Initializing...</span>
                    </p>
                </div>
                
                <button id="cancel-btn" class="btn secondary">Cancel</button>
            </div>
        </section>

        <!-- Complete Section -->
        <section id="complete-section" class="section hidden">
            <div class="complete-info">
                <h2>‚úÖ Processing Complete!</h2>
                
                <p>File: <strong id="complete-filename"></strong></p>
                <p>Duration: <strong id="processing-duration"></strong></p>
                
                <button id="download-btn" class="btn primary large">
                    ‚¨áÔ∏è Download Results (<span id="result-size"></span>)
                </button>
                
                <div class="alert info">
                    ‚è∞ Download available for 24 hours.<br>
                    ‚ö†Ô∏è Do not reload this page until you have downloaded your results.
                </div>
                
                <button id="new-upload-btn" class="btn secondary">
                    Process Another
                </button>
            </div>
        </section>

        <!-- Error Section -->
        <section id="error-section" class="section hidden">
            <div class="error-info">
                <h2>‚ùå Processing Error</h2>
                <p id="error-message"></p>
                <button id="retry-btn" class="btn primary">Try Again</button>
            </div>
        </section>

        <!-- Footer with Stats -->
        <footer>
            <div class="stats">
                üìä <span id="total-processed">0</span> images processed | 
                <span id="unique-users">0</span> users |
                Avg time: <span id="avg-time">0</span> min
            </div>
            <div class="disclaimer">
                ‚ö†Ô∏è Research use only. Not for clinical diagnosis.
            </div>
        </footer>
    </div>

    <!-- FilePond JS (pinned version for reproducibility) -->
    <script src="https://unpkg.com/filepond@4.31.4/dist/filepond.js"></script>
    <script src="/js/app.js"></script>
</body>
</html>
